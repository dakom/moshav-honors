<html>

<head>
    <style type="text/css">
        span.highlight {
            background-color: yellow;
        }
    </style>
</head>

<body>
    <script type="text/javascript">
        var configSettings =
            '{"honors":[{"id":"DVAR","name":"D\'var Torah"},{"id":"KABBALAT","name":"Kabbalat Shabbat"},{"id":"SHACHARIT","name":"Shacharit"},{"id":"GABBAI","name":"Gabbai"},{"id":"HAFTORAH","name":"Haftorah"},{"id":"MUSAF","name":"Musaf"},{"id":"MINCHA","name":"Mincha"},{"id":"MAARIV","name":"Maariv"}],"people":[{"name":"Reuvein","rejectHonors":["GABBAI"]},{"name":"Shimon","acceptHonors":["DVAR","MINCHA"]},{"name":"Levi"}],"invalidCombos":[["GABBAI","HAFTORAH"],["SHACHARIT","MUSAF"]]}';

        //NOTHING TO TOUCH BELOW THIS LINE!



        var HONORS = (function() {
            var people, honors, honorIndexLookup, invalidHonorComboMasks, FULL_MASK;
            var debugLog = [];

            function honorListToMask(hList) {
                var hMask = 0;

                if (hList !== undefined) {
                    for (var i = 0; i < hList.length; i++) {
                        var honor = honors[hList[i]];
                        hMask |= honor.bit;
                    }
                }

                return hMask;
            }

            function honorMaskToList(honorMask) {
                var ret = [];

                //shift each bit off the end until there's nothing left, and track the shift count in case there's a match
                for (var i = 0; honorMask > 0; honorMask >>= 1, i++) {
                    var honorBit = honorMask & 1;
                    if (honorMask & honorBit) {
                        ret.push(honorIndexLookup[i].id);
                    }
                }

                return ret;
            }

            function honorMaskToHtmlList(honorMask, addHighlight) {

                var str = "";
                var hList = honorMaskToList(honorMask);

                //shift each bit off the end until there's nothing left, and track the shift count in case there's a match
                for (var i = 0; i < hList.length; i++) {
                    str += "<li>";
                    if (addHighlight) {
                        str += "<span class='highlight'>";
                    }
                    str += honors[hList[i]].name;
                    if (addHighlight) {
                        str += "</span>";
                    }
                    str += "</li>";

                }
                if (str !== "") {
                    str = "<ul>" + str + "</ul>";
                } else {
                    str = "<ul>[NONE]</ul>";
                }

                return str;
            }

            function historyToHtmlList(history) {

                var str = "";
                for (var honorName in history) {
                    str += "<li>" + honorName + ": " + history[honorName].count + "</li>";
                }

                if (str !== "") {
                    str = "<ul>" + str + "</ul>";
                } else {
                    str = "<ul>[NONE]</ul>";
                }

                return str;
            }

            function init(peopleConfig, honorsConfig, invalidCombosConfig) {
                people = [];
                honors = {};
                honorIndexLookup = [];
                invalidHonorComboMasks = [];

                FULL_MASK = 0;

                for (var i = 0; i < honorsConfig.length; i++) {
                    var honor = honorsConfig[i];
                    honor.bit = 1 << i;
                    honor.idx = i;
                    honors[honor.id] = honor;
                    honorIndexLookup.push(honor);

                    FULL_MASK |= honor.bit;
                }

                for (var i = 0; i < peopleConfig.length; i++) {
                    var personConfig = peopleConfig[i];
                    var acceptHonorMask = honorListToMask(personConfig.acceptHonors);
                    var rejectHonorMask = honorListToMask(personConfig.rejectHonors);

                    //start by assuming user can have any honor
                    var potentialHonorMask = FULL_MASK;

                    //if they are only accepting certain ones, that's our actual starting point
                    if (acceptHonorMask != 0) {
                        potentialHonorMask = acceptHonorMask;
                    }

                    //from what's remaining, reject the specific ones they want rejected if any are set
                    if (rejectHonorMask != 0) {
                        potentialHonorMask &= ~rejectHonorMask;
                    }

                    var person = {
                        index: i,
                        acceptHonorMask: acceptHonorMask,
                        rejectHonorMask: rejectHonorMask,
                        name: personConfig.name,
                        potentialHonorMask: potentialHonorMask,
                        honorMask: 0
                    }

                    if (personConfig.history !== undefined) {
                        person.history = personConfig.history;
                    }

                    people.push(person);
                }


                for (var i = 0; i < invalidCombosConfig.length; i++) {
                    var comboMask = honorListToMask(invalidCombosConfig[i]);
                    invalidHonorComboMasks.push(comboMask);
                }


            }

            function generateAssignments() {


                for (var i = 0; i < honorIndexLookup.length; i++) {
                    var honor = honorIndexLookup[i];

                    //get potential people for this honor, i.e. names which have this honor in their potentialHonorMask
                    var potentialPeople = (function() {


                        var ret = [];
                        for (var pi = 0; pi < people.length; pi++) {
                            var person = people[pi];
                            if (person.potentialHonorMask & honor.bit) {
                                ret.push(person);
                            }
                        }

                        return ret;

                    })();

                    //if nobody is available for this honor, then everybody is available for this honor
                    if (potentialPeople.length == 0) {
                        potentialPeople = people;
                    }

                    //for each honor, assign it to a random person on the list - and cull the list as needed against their potential honors
                    (function assignHonor(targetList) {
                        var pi = Math.floor(Math.random() * targetList.length);
                        var person = targetList[pi];
                        var culledList;

                        //Check for invalid combos...
                        //if the list is reduced to just one person (i.e. everyone else was invalidated too), then they are it
                        if (targetList.length > 1) {
                            for (var c = 0; c < invalidHonorComboMasks.length; c++) {
                                var combo = invalidHonorComboMasks[c];

                                //if the target honor falls in one of the invalid combos...
                                //and the person has one of those combos assigned...
                                if (((honor.bit & combo) != 0) && ((person.honorMask & combo) != 0)) {
                                    log("Not assigning [" + honor.id + "] to [" + person.name + "], combo of: [" + honorMaskToList(combo) + "] is invalid and they have: [" + honorMaskToList(person.honorMask) + "] which yields exclusion on [" + honorMaskToList(person.honorMask & combo) + "]");

                                    //take this person out of the running for this honor on the next try
                                    //but do it via a copy so that the next honor uses the full list
                                    culledList = targetList.concat();
                                    culledList.splice(pi, 1);
                                    break;
                                }
                            }
                        }

                        if (culledList === undefined) {
                            person.honorMask |= honor.bit;
                            if (person.history === undefined) {
                                person.history = {};
                            }

                            if (person.history[honor.id] === undefined) {
                                person.history[honor.id] = {
                                    count: 0
                                };
                            }
                            person.history[honor.id].count++;

                        } else {
                            assignHonor(culledList);
                        }


                    })(potentialPeople);

                }
            }



            function exportNewConfig() {
                //strip the unnecessary data from what we've got and provide in proper config format

                var honorsConfig = [];
                for (var i = 0; i < honorIndexLookup.length; i++) {
                    var honor = honorIndexLookup[i];
                    honorsConfig.push({
                        id: honor.id,
                        name: honor.name,
                    });
                }

                var peopleConfig = [];
                for (var i = 0; i < people.length; i++) {
                    var person = people[i];
                    var personConfig = {
                        name: person.name
                    }

                    if (person.acceptHonorMask != 0) {
                        personConfig.acceptHonors = honorMaskToList(person.acceptHonorMask);
                    }

                    if (person.rejectHonorMask != 0) {
                        personConfig.rejectHonors = honorMaskToList(person.rejectHonorMask);
                    }

                    if (person.history !== undefined) {
                        personConfig.history = person.history;
                    }

                    peopleConfig.push(personConfig);
                }

                var invalidCombosConfig = [];
                for(var i = 0; i < invalidHonorComboMasks.length; i++) {
                  invalidCombosConfig.push(honorMaskToList(invalidHonorComboMasks[i]));
                }

                return {
                    honors: honorsConfig,
                    people: peopleConfig,
                    invalidCombos: invalidCombosConfig
                }

                return exportConfig;
            }

            function printPeople() {

                for (var i = 0; i < people.length; i++) {
                    var person = people[i];
                    var html = "";
                    html += "<ul>";
                    html += "<li><h3>" + person.name + "</h3></li>";
                    html += "<ul><li>Assigned: " + honorMaskToHtmlList(person.honorMask, true) + "</li></ul>";
                    html += "<ul><li>Potential Options: " + honorMaskToHtmlList(person.potentialHonorMask) + "</li></ul>";
                    html += "<ul><li>Updated History: " + historyToHtmlList(person.history) + "</li></ul>";
                    html += "<ul><li>Configured Accepting: " + honorMaskToHtmlList(person.acceptHonorMask) + "</li></ul>";
                    html += "<ul><li>Configured Rejecting: " + honorMaskToHtmlList(person.rejectHonorMask) + "</li></ul>";
                    html += "</ul>";

                    document.write(html);
                }
            }

            function log(str) {
              console.log(str);
              debugLog.push(str);
            }

            return {
                Init: function(configSettings) {
                    config = JSON.parse(configSettings);
                    init(config.people, config.honors, config.invalidCombos);
                },

                GenerateAssignments: generateAssignments,

                ExportNewConfig: exportNewConfig,

                PrintPeople: printPeople,


                PrintDebugLog: function() {
                  for(var i = 0; i < debugLog.length; i++) {
                    document.write("<p><b>" + debugLog[i] + "</b></p>");
                  }


                }
            }

        }());

        HONORS.Init(configSettings);
        HONORS.GenerateAssignments();
        HONORS.PrintPeople();
        HONORS.PrintDebugLog();

        document.write("<p> Original Config: " + configSettings + "</p>");
        document.write("<p> Updated Config: " + JSON.stringify(HONORS.ExportNewConfig())+ "</p>");

    </script>
</body>

</html>
